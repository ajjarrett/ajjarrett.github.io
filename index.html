<html>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style> circle {fill: lightblue; stroke: black;}</style>
    <link rel="stylesheet" href="/css/styles.css" />

    <body onload="init()">

    <div id="welcome-bar">Exploring Data with D3</div>

    <div id="plot-area">
        <div>
            <svg width="1100" height="700" border="solid"></svg>
            <div id="tooltip"></div>
        </div>

        <div id="forms">
            <script>
                function to_submit() {
                    console.log('Submitted!');
                }
                // range slider: https://www.w3schools.com/howto/howto_js_rangeslider.asp
            </script>
            <label for="cars">Choose a car:</label>
            <select id="cars" name="cars" onclick="to_submit()">
              <option value="volvo">Volvo</option>
              <option value="saab">Saab</option>
              <option value="fiat">Fiat</option>
              <option value="audi">Audi</option>
            </select>

            <button onclick="to_submit()">Submit</button>

            <div class="slidecontainer">
                <input type="range" min="2000" max="2024" value="2022" class="slider" id="myRange" step="2">
                <p id="demo"></p>
            </div>
            <script>
                var slider = document.getElementById("myRange");
                var output = document.getElementById("demo");
                output.innerHTML = slider.value; // Display the default slider value
                var YEAR = slider.value;

                // Update the current slider value (each time you drag the slider handle)
                slider.oninput = function() {
                output.innerHTML = this.value;
                }             
            </script>
            
            <form>
                <label for="start_date">Start date:</label>
                <input type="text" id="start_date" name="start_date">
                <p> - </p>
                <label for="end_date">End date:</label>
                <input type="text" id="end_date" name="end_date">
            </form>
        </div>

    </div>

    <div id="footer-bar">Created by Austin Jarrett</div>

    <script>
    async function init() {



        // Set variable for svg, margin, width, height
        var svg = d3.select("svg"),
            margin = 120;
            width = +svg.attr("width") - 2*margin,
            height = +svg.attr("height") - 2*margin;

        // X Scale
        var x = d3.scaleBand().range([0,width]);

        // Y Scale
        var y = d3.scaleLinear().range([height,0]);

        // Bar chart reference: https://www.youtube.com/watch?v=i0GdXYgw924
        // Read Data from CSV
        const data = await d3.csv("Olympics" + YEAR + "_sorted.csv", function(d) {
            return {
                Team : d.Team,
                Gold : +d.Gold,
                Silver : +d.Silver,
                Bronze : +d.Bronze,
                Total : +d.Total,
            }
        })

        x.domain(data.map(function(d) {return d.Team;}));
        y.domain([0, d3.max(data, function(d) {return d.Total;})]);

        // Title
        svg.append('text')
        .attr('x', width/2 + margin)
        .attr('y', margin/2)
        .attr('text-anchor', 'middle')
        .style('font-size', 20)
        .text('Olympic Medals by Country');

        // X label

        // Y label
        svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('transform', 'translate(' + margin/2 + ',' + (height/2 + margin) + ')rotate(-90)')
        .style('font-size', 14)
        .text('Number of Medals');

        // Left Axis
        svg.append('g')
        .attr('transform', 'translate(' + margin + ',' + margin + ')')
        .call(d3.axisLeft(y));

        // Bottom Axis
        svg.append('g')
        .attr('transform', 'translate(' + margin + ',' + (height + margin) + ')')
        .call(d3.axisBottom(x))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-65)');

        // Rotate X axis labels Reference: http://www.d3noob.org/2013/01/how-to-rotate-text-labels-for-x-axis-of.html

        // Create a tooltip
        var my_tooltip = d3.select('#tooltip');


        // Mouseover Events
        var mouseover = function(d, i) {
            my_tooltip.style('opacity', 1)
            .style('left', (d3.event.pageX) + 'px')
            .style('top', (d3.event.pageY) + 'px')
            //.style('left', (d3.mouse(this)[0]+70) + 'px')
            //.style('top', (d3.mouse(this)[1]+70) + 'px')
            //d3.select(this).style('stroke', 'black')
            .html(d.data.Team + ' is ' + d[1])
        }

        var mousemove = function(d, i) {
            my_tooltip.style('opacity', 1)
            .style('left', (d3.event.pageX) + 'px')
            .style('top', (d3.event.pageY) + 'px')
            //.style('left', (d3.mouse(this)[0]+70) + 'px')
            //.style('top', (d3.mouse(this)[1]+70) + 'px')
            //d3.select(this).style('stroke', 'black')
            .html(d.data.Team +  '<br>' + d[1])
        }

        var mouseleave = function(d) {
            my_tooltip
            .style('opacity', 0)
            //d3.select(this).style('stroke', 'none').style('opacity', 0.8)
        }

        // MEDALS: List of subgroups = header of the csv files
        var subgroups = data.columns.slice(1);
        console.log(subgroups)
        var index = subgroups.indexOf('Total');
        var removed_subgroup = subgroups.splice(index,1);
        console.log(subgroups)

        // NATIONS: List of groups = value of the first column called Team - shown on the X axis
        var groups = d3.map(data, function(d){return(d.Team)}).keys()

        // Color palette = one color per subgroup
        var color = d3.scaleOrdinal()
        .domain(subgroups)
        .range(['gold','silver','brown'])

        var stackedData = d3.stack()
        .keys(subgroups)(data)
    
        // Add BAR PLOT OF TOTALS
        /*
        svg.append('g')
        .selectAll('bar')
        .data(data)
        .enter()
        .append('rect')
        .attr('x', function(d) {return x(d.Team);})
        .attr('y', function(d) {return y(d.Total); })
        .attr('width', x.bandwidth())
        .attr('height', function(d) {return height - y(d.Total);})
        .attr('transform', 'translate(' + margin + ',' + margin + ')')
        .style('fill', '#CC0000')
        .on('mouseover', mouseover)
        .on('mousemove', mousemove)
        .on('mouseleave', mouseleave);
        */

        // Stacked bar plot reference: https://d3-graph-gallery.com/graph/barplot_stacked_basicWide.html
        svg.append("g")
        .selectAll("g")
        // Enter in the stack data = loop key per key = group per group
        .data(stackedData)
        .enter()
        .append("g")
        .attr("fill", function(d) { return color(d.key); })
        .selectAll("rect")
        // enter a second time = loop subgroup per subgroup to add all rectangles
        .data(function(d) { return d; })
        .enter()
        .append("rect")
            .attr("x", function(d) { return x(d.data.Team); })
            .attr("y", function(d) { return y(d[1]); })
            .attr("height", function(d) { return y(d[0]) - y(d[1]); })
            .attr("width", x.bandwidth())
            .attr('transform', 'translate(' + margin + ',' + margin + ')')
        .on('mouseover', mouseover)
        .on('mousemove', mousemove)
        .on('mouseleave', mouseleave);



        // RESOURCES
        // Reference legend with automatic hide/show: http://www.d3noob.org/2014/07/d3js-multi-line-graph-with-automatic.html
        // Tooltips reference: https://d3-graph-gallery.com/graph/interactivity_tooltip.html

        // TASKS
        // TODO-1: add filters
        // TODO-2: add legend
        // TODO-3: add pages with explanations and ability to navigate between them
    }

    // Alternate dataset: https://olympics.com/en/olympic-games/tokyo-2020/medals
    </script>
    </body>
</html>